<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Surprise - My Bini</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --minnie-pink: #ffadad;
            --minnie-dark-pink: #ff8585;
            --bg-home-pink: #fff0f0;
            --white: #ffffff;
        }

        * { box-sizing: border-box; }
        
        body, html { 
            margin: 0; padding: 0; 
            font-family: 'Poppins', sans-serif; 
            height: 100%; width: 100%;
            background: var(--bg-home-pink); 
            overflow: hidden; 
        }

        .phone-screen {
            width: 100%; height: 100%;
            background: var(--bg-home-pink);
            position: relative; overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* --- BAGIAN HEADER --- */
        .unified-header {
            position: relative; width: 100%;
            background-image: url('images/happy.png');
            background-size: cover; background-position: center;
            color: white; z-index: 10; flex-shrink: 0;
        }

        .header-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 173, 173, 0.4); z-index: 1;
        }

        .wa-top-bar {
            position: relative; z-index: 2; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 600; font-size: 1.3rem;
        }

        .wa-tabs {
            position: relative; z-index: 2; display: flex; text-align: center;
            font-size: 0.9rem; font-weight: 600;
        }

        .wa-tabs div { padding: 12px 0; flex: 1; border-bottom: 4px solid transparent; opacity: 0.9; }
        .wa-tabs .active { border-bottom: 4px solid white; opacity: 1; }

        /* --- DAFTAR CHAT BERANDA --- */
        .chat-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .chat-item { 
            display: flex; align-items: center; padding: 15px 20px; 
            border-bottom: 1px solid rgba(255, 133, 133, 0.1); 
            cursor: pointer; background: rgba(255, 255, 255, 0.5);
            margin: 5px 15px; border-radius: 15px; transition: 0.3s;
        }

        .profile-pic { width: 55px; height: 55px; border-radius: 50%; margin-right: 15px; border: 2px solid var(--white); object-fit: cover; flex-shrink: 0; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-weight: 600; color: #444; font-size: 1.05rem; }
        .unread-badge { background: var(--minnie-dark-pink); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; }

        /* --- ROOM CHAT --- */
        #chat-room { height: 100%; width: 100%; flex-direction: column; display: none; }
        .wa-header-chat { 
            position: relative; background-image: url('images/happy.png'); background-size: cover; background-position: center; 
            color: white; padding: 10px 20px; display: flex; align-items: center; gap: 15px; height: 70px; flex-shrink: 0;
        }

        .chat-room-bg { 
            flex: 1; 
            background-size: cover; 
            background-position: center;
            display: flex; flex-direction: column; overflow: hidden;
            transition: background 0.3s ease;
        }

        .chat-box { flex: 1; padding: 15px 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        
        .msg { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word;}
        .msg img { width: 100%; max-width: 300px; border-radius: 10px; margin-top: 5px; display: block; cursor: pointer; }
        .sender-tag { font-size: 0.75rem; font-weight: bold; margin-bottom: 3px; display: block; }
        .bot { background: rgba(255, 255, 255, 0.95); align-self: flex-start; border-top-left-radius: 2px; }
        .user { background: rgba(255, 222, 222, 0.95); align-self: flex-end; border-top-right-radius: 2px; }

        .c1 { color: #e91e63; } .c2 { color: #9c27b0; } .c3 { color: #3f51b5; } .c4 { color: #009688; } .c5 { color: #9c27b0; } .c6 { color: #e91e63; } .c7 { color: #9c27b0; } .c8 { color: #3f51b5; } .c9 { color: #009688; } .c10 { color: #e91e63; } .c11 { color: #e91e63; }

        .chat-footer { padding: 10px 20px; background: white; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .input-area { display: flex; align-items: center; gap: 12px; }
        .input-field { flex: 1; background: #f0f0f0; border-radius: 30px; padding: 12px 20px; border: none; outline: none; font-size: 1rem; }
        .send-btn { background: var(--minnie-pink); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: none; cursor: pointer; }

        /* --- ZOOM LIGHTBOX STYLE --- */
        #lightbox {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center;
            overflow: hidden; touch-action: none;
        }
        #lightbox img { 
            max-width: 90%; max-height: 90%; object-fit: contain; 
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); 
            cursor: zoom-in;
            user-select: none;
            -webkit-user-drag: none;
        }
        .close-zoom { position: absolute; top: 30px; right: 30px; color: white; font-size: 40px; z-index: 2001; cursor: pointer; opacity: 0.8; }
        .close-zoom:hover { opacity: 1; }

        /* --- FIREWORKS LAYER --- */
        #fireworks-layer { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 100; }
        #fwCanvas { width: 100%; height: 100%; touch-action: none; }
        #next-btn { 
            display: none; position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); 
            background: var(--minnie-dark-pink); color: white; border: none; padding: 15px 35px; 
            border-radius: 50px; font-weight: bold; z-index: 101; cursor: pointer; 
            animation: bounce 2s infinite; text-align: center;
        }

        /* --- FINAL SCREEN --- */
        #final-screen { 
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-image: url('images/happy.png'); 
            background-size: cover;
            background-position: center;
            text-align: center; justify-content: center; 
            align-items: center; flex-direction: column; z-index: 1000; padding: 20px; 
        }

        #final-screen::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 240, 240, 0.4); z-index: -1;
        }

        .final-card { 
            background: white; padding: 40px; border-radius: 40px; 
            border: 3px solid var(--minnie-pink); width: 95%; max-width: 500px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            position: relative;
        }

        .photo-frame { 
            width: 180px; height: 180px; border-radius: 50%; 
            overflow: hidden; border: 6px solid var(--minnie-pink); 
            margin: 0 auto 25px; background: #eee;
        }
        
        .photo-frame img { width: 100%; height: 100%; object-fit: cover; }

        @media (orientation: landscape) {
            .phone-screen { height: 100%; }
            .wa-header-chat { height: 55px; padding: 5px 20px; }
            .chat-box { padding: 10px 20px; }
            .chat-footer { padding: 5px 20px; }
            .photo-frame { width: 110px; height: 110px; margin-bottom: 10px; }
            .final-card { padding: 15px; width: 90%; max-width: 450px; border-radius: 25px; }
            .final-card h1 { font-size: 1.6rem !important; margin: 0; }
            .final-card p { font-size: 0.8rem; margin: 5px 0; }
            .final-card button { padding: 10px 25px; margin-top: 10px; font-size: 0.8rem; }
            .msg img { max-width: 200px; }
        }

        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);} 40% {transform: translateX(-50%) translateY(-15px);} }
    </style>
</head>
<body>

<audio id="backsound" src="lagu/bersamamu.mp3" loop></audio>
<audio id="firework-launch" src="lagu/kembang apii.mp3" preload="auto"></audio>
<audio id="firework-burst" src="lagu/kembang api.mp3" preload="auto"></audio>

<div id="lightbox" onclick="closeZoom()">
    <span class="close-zoom" onclick="closeZoom()">&times;</span>
    <img id="zoom-img" src="" onmousedown="startDrag(event)" ontouchstart="startDrag(event)" onclick="handleImageClick(event)">
</div>

<div class="phone-screen">
    <div id="home-screen" style="display: flex; flex-direction: column; height: 100%;">
        <div class="unified-header">
            <div class="header-overlay"></div>
            <div class="wa-top-bar">
                <span>WhatsApp</span>
                <div style="display: flex; gap: 20px;"><i class="fas fa-search"></i><i class="fas fa-ellipsis-v"></i></div>
            </div>
            <div class="wa-tabs">
                <div class="active">CHAT</div>
                <div>STATUS</div>
                <div>PANGGILAN</div>
            </div>
        </div>

        <div class="chat-list">
            <div class="chat-item" onclick="openChat('personal')">
                <img src="images/2.jpeg" class="profile-pic">
                <div class="chat-info">
                    <div style="display: flex; justify-content: space-between;">
                        <span class="chat-name">Mistermine ‚ô°</span>
                        <span style="font-size: 0.75rem; color: var(--minnie-dark-pink);">25.09</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: #777; font-size: 0.88rem;">
                        <span>Sayaaaaaaanggggggg...</span>
                        <span class="unread-badge">1</span>
                    </div>
                </div>
            </div>

            <div class="chat-item" onclick="openChat('group')">
                <img src="images/1.jpeg" class="profile-pic">
                <div class="chat-info">
                    <div style="display: flex; justify-content: space-between;">
                        <span class="chat-name">Natares Fam.ily</span>
                        <span style="font-size: 0.75rem; color: #999;">25.09</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: #777; font-size: 0.88rem;">
                        <span>Bunaaaaaaaaaaa üéâ</span>
                        <span class="unread-badge">4</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; padding: 25px; color: #ff8585; font-size: 0.9rem; font-weight: 600; font-style: italic;">
                "buka grup dulu baru chat dari aku sayang"
            </div>
        </div>
    </div>

    <div id="chat-room">
        <div class="wa-header-chat">
            <div class="header-overlay"></div>
            <div style="position: relative; z-index: 2; display: flex; align-items: center; gap: 15px; width: 100%;">
                <i class="fas fa-arrow-left" onclick="location.reload()"></i>
                <img id="header-img" src="images/happy.png" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; object-fit: cover;">
                <div style="flex: 1;">
                    <div id="chat-title" style="font-weight: 600;">Mistermine ‚ô°</div>
                    <div id="chat-status" style="font-size: 0.75rem; opacity: 0.9;">Online</div>
                </div>
                <div style="display: flex; gap: 15px;"><i class="fas fa-video"></i><i class="fas fa-phone"></i><i class="fas fa-ellipsis-v"></i></div>
            </div>
        </div>
        <div class="chat-room-bg">
            <div id="chat-box" class="chat-box"></div>
            <div id="options-area" style="padding: 15px; display: none; justify-content: center; background: white; border-top: 1px solid #eee;"></div>
            <div class="chat-footer">
                <div class="hint-text" id="hint-msg" style="font-size: 0.75rem; color: #ff8585; text-align: center; font-weight: 600;">Ketik apapun dan kirimkan</div>
                <div class="input-area">
                    <input type="text" id="user-input" class="input-field" placeholder="Ketik pesan">
                    <button class="send-btn" onclick="handleSend()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="fireworks-layer">
        <canvas id="fwCanvas"></canvas>
        <button id="next-btn" onclick="showFinalScreen()">
            Lihat Kejutannya ‚ù§Ô∏è<br>
            <span style="font-size: 0.75rem; font-weight: normal; opacity: 0.9;">
                (tap tap buat main kembang api dulu biar bahagia sayang)
            </span>
        </button>
    </div>

    <div id="final-screen">
        <div class="final-card">
            <div class="photo-frame"><img src="images/12.jpeg" onerror="this.src='https://via.placeholder.com/200?text=Foto+Personal'"></div>
            <h1 style="font-family: 'Dancing Script'; color: #ff6b6b; font-size: 2.5rem; margin: 0;">I Love You</h1>
            <p style="color: #666; margin-top: 15px;">"Selamat ulang tahun Sayang. Kamu adalah kado terindah dalam hidupku."</p>
            <button style="background: var(--minnie-pink); color: white; border: none; padding: 15px 40px; border-radius: 30px; margin-top: 25px; font-weight: bold; cursor: pointer;" onclick="location.reload()">Ulangi Bahagia</button>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const hintMsg = document.getElementById('hint-msg');
    const fwCanvas = document.getElementById('fwCanvas');
    const ctx = fwCanvas.getContext('2d');

    let currentMode = '';
    let groupStep = 0; 
    let personalStep = 0; 
    let particles = [];
    let rockets = [];
    let canInteract = false;
    let sequenceQueue = [];
    let bgInterval;
    let sfxMuted = false;
    let isSubExplosionActive = false;

    const lightbox = document.getElementById('lightbox');
    const zoomImg = document.getElementById('zoom-img');
    let isZoomed = false;
    let lastTap = 0;
    let isDragging = false;
    let startX, startY;
    let translateX = 0, translateY = 0;

    function openZoom(src) {
        zoomImg.src = src;
        lightbox.style.display = 'flex';
        resetZoomState();
    }

    function closeZoom() {
        lightbox.style.display = 'none';
        resetZoomState();
    }

    function resetZoomState() {
        isZoomed = false;
        translateX = 0; translateY = 0;
        zoomImg.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1)';
        updateTransform();
    }

    function updateTransform() {
        const scale = isZoomed ? 2.5 : 1;
        zoomImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    function handleImageClick(event) {
        event.stopPropagation();
        const now = new Date().getTime();
        const timesince = now - lastTap;
        if (timesince < 300 && timesince > 0) {
            isZoomed = !isZoomed;
            updateTransform();
        }
        lastTap = now;
    }

    function startDrag(e) {
        if (!isZoomed) return;
        isDragging = true;
        zoomImg.style.transition = 'none';
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        startX = clientX - translateX;
        startY = clientY - translateY;
        window.addEventListener('mousemove', drag);
        window.addEventListener('touchmove', drag, { passive: false });
        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchend', endDrag);
    }

    function drag(e) {
        if (!isDragging) return;
        if (e.cancelable) e.preventDefault();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        translateX = clientX - startX;
        translateY = clientY - startY;
        updateTransform();
    }

    function endDrag() {
        isDragging = false;
        window.removeEventListener('mousemove', drag);
        window.removeEventListener('touchmove', drag);
    }

    function scrollBottom() { chatBox.scrollTop = chatBox.scrollHeight; }

    function addGroupMsg(name, text, colorClass, isPhoto = false, photoSrc = '') {
        const div = document.createElement('div');
        div.className = "msg bot";
        let content = `<span class="sender-tag ${colorClass}">${name}</span>`;
        if(isPhoto) content += `<img src="${photoSrc}" onclick="openZoom(this.src)" onerror="this.src='https://via.placeholder.com/300x200?text=Foto+${name}'">`;
        if(text) content += `<span>${text}</span>`;
        div.innerHTML = content;
        chatBox.appendChild(div);
        scrollBottom();
    }

    function addPersonalMsg(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = text;
        chatBox.appendChild(div);
        scrollBottom();
    }

    function openChat(mode) {
        currentMode = mode;
        chatBox.innerHTML = '';
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('chat-room').style.display = 'flex';
        const chatBg = document.querySelector('.chat-room-bg');

        if (mode === 'group') {
            document.getElementById('chat-title').innerText = "Natares Fam.ily";
            document.getElementById('header-img').src = "images/1.jpeg";
            chatBg.style.backgroundImage = "url('images/10.jpeg')"; 
            addGroupMsg("Mistermine ‚ô°", "Gaesss, Hari ini ada yang harus bahagia nihhh üôä‚ù§Ô∏è", "c1");
            setTimeout(() => addGroupMsg("Alennn", "Wah iya! siapa tuh yahhh üôä", "c2"), 500);
            setTimeout(() => addGroupMsg("Amoyy", "Bunaaaaaaaaaaaa, Happy Birthdayy yaaa. semoga buna selalu bahagia, makin cantik, makin sayang sama yayah, pokonya terbaik buat buna. I LOVE YOU ‚ù§Ô∏è", "c3"), 1000);
            setTimeout(() => addGroupMsg("Eisyyy", "Happy Birthday Bunaaaa eisy yg paling cantik paling baikk. aku sayang bunaaaa, nikah sama yayah nya cepetin ya buna biar aku bisa cepet nemenin buna di dunia üòöü§çü§≠", "c4"), 1500);
            setTimeout(() => addGroupMsg("Alennn", "Happy Birthday Bunaaa, semoga buna panjang umur, sehat selalu dan bahagia selaluu. pingin deh cpt bisa nemenin dan jagain buna disanaaü§≠ IloveYou Buna ü§ç", "c5"), 2000);
            setTimeout(() => addGroupMsg("Mistermine ‚ô°", "Happy Birthday sayangg. aku sayang banget sama kamuuüéÇ‚ú®ü§çü§çü§çüéâüéäüéÅüéà", "c6"), 2500)
            setTimeout(() => addGroupMsg("Alennn", "Cieeeee yayah üôä", "c7"), 3000);
            setTimeout(() => addGroupMsg("Amoyy", "Cieeeee hahaha Buna senyum-senyum sendiri tuh ahahüôä", "c8"), 3500);
            setTimeout(() => addGroupMsg("Eisyyy", "Cieeeee Bunaaa wkwkwkkwkwkwkw üôä", "c9"), 4000);
            setTimeout(() => addGroupMsg("Mistermine ‚ô°", "kalian ayo kirim hadiah nyaaa üôä", "c10"), 4500);
            setTimeout(() => addGroupMsg("Mistermine ‚ô°", "bun, coba bilang sesuatu biar mereka kirim hadiahnyaüòÜ", "c11"), 5000);
        } else {
            document.getElementById('chat-title').innerText = "Mistermine ‚ô°";
            document.getElementById('header-img').src = "images/2.jpeg";
            chatBg.style.backgroundImage = "url('images/aku.png')";
            addPersonalMsg("Halo Sayangku... ‚ù§Ô∏è", "bot");
            setTimeout(() => {
                addPersonalMsg("sekali lagi Happy Birthday sayangg. semoga kamu sehat selalu, makin berkah umurnya, makin cantik, makin bahagia hidup kamu dan makin bahagia sama aku. semoga kamu makin jadi pribadi yang lebih baik, dan semua yang kamu impikan tercapai. do'ain aku ya biar bisa nikahin kamu tahun sekarang ü§ó aku sayang banget sama kamuuüéÇ‚ú®ü§çü§çü§çüéâüéäü™ÖüéÅüéà", "bot");
                hintMsg.innerText = "Balas pesan aku di atas dulu sayang..";
            }, 1000);
            document.getElementById('options-area').style.display = 'none';
        }
    }

    function handleSend() {
        const val = userInput.value.trim();
        if(!val) return;
        addPersonalMsg(val, "user");
        userInput.value = '';
        if(currentMode === 'group') {
            if(groupStep === 0) {
                groupStep = 1;
                hintMsg.innerText = "Tunggu sebentar...";
                setTimeout(() => addGroupMsg("Mistermine ‚ô°", "", "c1", true, "images/2.jpeg"), 1000);
                setTimeout(() => addGroupMsg("Alennn", "", "c2", true, "images/4.jpeg"), 2500);
                setTimeout(() => addGroupMsg("Amoyy", "", "c3", true, "images/5.jpeg"), 4000);
                setTimeout(() => addGroupMsg("Eisyyy", "", "c4", true, "images/3.jpeg"), 5500);
                setTimeout(() => {
                    addGroupMsg("Mistermine ‚ô°", "Ehh ada 1 lagi nih buat kamu..", "c1");
                    hintMsg.innerText = "Ketik apapun untuk kejutan terakhir";
                }, 7000);
            } else if(groupStep === 1) {
                groupStep = 2;
                setTimeout(() => {
                    addGroupMsg("Mistermine ‚ô°", "Taraaaaa! Happy Birthday bunaaa!!!‚ù§Ô∏è‚ú®", "c1", true, "images/11.jpeg");
                    setTimeout(() => {
                        document.getElementById('options-area').style.display = 'flex';
                        document.getElementById('options-area').innerHTML = `<button style="background:var(--minnie-pink); color:white; border:none; padding:12px 25px; border-radius:25px; font-weight:600; cursor:pointer;" onclick="openChat('personal')">Buka Chat Mistermine ‚ù§Ô∏è</button>`;
                        scrollBottom();
                    }, 1000);
                }, 500);
            }
        } else {
            if(personalStep === 0) {
                personalStep = 1;
                setTimeout(() => {
                    addPersonalMsg("sayang, ada hadiah buat kamu. siap?", "bot");
                    hintMsg.innerText = "Ketik 'siap' lalu kirimkan";
                }, 1000);
            } else if (personalStep === 1) {
                if(val.toLowerCase() === "siap") {
                    personalStep = 2;
                    hintMsg.innerText = "Tunggu kejutanmu...";
                    setTimeout(() => {
                        addPersonalMsg("oke", "bot");
                        setTimeout(() => {
                            addPersonalMsg("1...", "bot");
                            setTimeout(() => {
                                addPersonalMsg("2...", "bot");
                                setTimeout(() => {
                                    addPersonalMsg("3... mwaaahhhh üòö", "bot");
                                    setTimeout(() => { startCelebration(); }, 1000);
                                }, 1000);
                            }, 1000);
                        }, 1000);
                    }, 1000);
                } else {
                    hintMsg.innerText = "Ketik 'siap' sayang biar kejutan muncul";
                }
            }
        }
    }

    userInput.addEventListener("keypress", (e) => { if (e.key === "Enter") handleSend(); });

    function playSfx(id, vol = 0.6) {
        if(sfxMuted) return;
        const original = document.getElementById(id);
        const clone = original.cloneNode();
        clone.volume = vol;
        clone.play();
        clone.onended = function() { clone.remove(); };
    }

    function startCelebration() {
        const audio = document.getElementById('backsound');
        audio.play().catch(e => console.log("Audio play blocked"));

        document.getElementById('fireworks-layer').style.display = 'block';
        resize(); animate();

        setTimeout(() => {
            rockets.push(new Rocket(fwCanvas.width/2, fwCanvas.height, fwCanvas.width/2, fwCanvas.height*0.3, false));
        }, 500);

        setTimeout(() => {
            sequenceQueue = [
                { text: "‚ù§Ô∏è", color: "#FF1493", fontSize: (window.innerWidth < 600 ? "150px" : "250px") },
                { text: "HBD SAYANG", color: "#FFADAD", fontSize: (window.innerWidth < 600 ? "40px" : "60px") },
                { text: "I LOVE YOU", color: "#FFFFFF", fontSize: (window.innerWidth < 600 ? "40px" : "60px") }
            ];
            processNext();
        }, 3500);

        setTimeout(() => {
            bgInterval = setInterval(() => {
                if (!isSubExplosionActive) {
                    const x = (Math.random() * fwCanvas.width * 0.8) + (fwCanvas.width * 0.1);
                    const y = (Math.random() * fwCanvas.height * 0.4) + (fwCanvas.height * 0.1);
                    // Acak antara kembang api biasa atau beranak
                    const isSub = Math.random() > 0.5;
                    rockets.push(new Rocket(x, fwCanvas.height, x, y, false, null, null, isSub));
                }
            }, 1500); 

            setTimeout(() => {
                canInteract = true;
                document.getElementById('next-btn').style.display = 'block';
            }, 5000); 
        }, 7000);
    }

    function processNext() {
        if (sequenceQueue.length === 0) return;
        const item = sequenceQueue.shift();
        rockets.push(new Rocket(fwCanvas.width/2, fwCanvas.height, fwCanvas.width/2, fwCanvas.height*0.4, true, item, () => setTimeout(processNext, 1200)));
    }

    function resize() { fwCanvas.width = window.innerWidth; fwCanvas.height = window.innerHeight; }

    class Rocket {
        constructor(sx, sy, tx, ty, isText, textData, onDone, isSub = false) {
            this.x = sx; this.y = sy; this.tx = tx; this.ty = ty;
            this.isText = isText; this.textData = textData; this.onDone = onDone;
            this.isSub = isSub; 
            this.alive = true; this.angle = Math.atan2(ty - sy, tx - sx);
            this.speed = isText ? 15 : 12;
            this.history = [];
            playSfx('firework-launch', 0.4);
            if(this.isSub) isSubExplosionActive = true;
        }
        update() {
            // Sejarah posisi untuk ekor yang lembut
            this.history.push({x: this.x, y: this.y});
            if (this.history.length > 15) this.history.shift();

            this.x += Math.cos(this.angle) * this.speed;
            this.y += Math.sin(this.angle) * this.speed;

            // Efek percikan api (sparks) di ekor agar lebih detail
            if (Math.random() > 0.3) {
                particles.push(new Particle(this.x, this.y, this.x + (Math.random()-0.5)*8, this.y + 12, "#ffdd00", false));
            }

            if (Math.hypot(this.tx - this.x, this.ty - this.y) < 20) {
                this.alive = false;
                playSfx('firework-burst', 0.6);
                if (this.isText) explodeText(this.textData, this.onDone);
                else explodeShape(this.tx, this.ty, this.isSub);
            }
        }
        draw() {
            // Draw Glowing Trail
            for (let i = 0; i < this.history.length; i++) {
                const p = this.history[i];
                const opacity = i / this.history.length;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2 * opacity, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 180, 50, ${opacity * 0.6})`;
                ctx.fill();
            }

            // Draw Rocket Head
            const grad = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, 6);
            grad.addColorStop(0, "white");
            grad.addColorStop(1, "orange");
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(this.x, this.y, 3.5, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function explodeText(data, callback) {
        const temp = document.createElement('canvas');
        const tCtx = temp.getContext('2d');
        temp.width = fwCanvas.width; temp.height = fwCanvas.height;
        tCtx.font = `bold ${data.fontSize} Arial`;
        tCtx.textAlign = 'center'; tCtx.textBaseline = 'middle';
        tCtx.fillText(data.text, temp.width/2, temp.height/2);
        const imgData = tCtx.getImageData(0,0,temp.width,temp.height).data;
        for (let y=0; y<temp.height; y+=6) {
            for (let x=0; x<temp.width; x+=6) {
                if (imgData[(y*temp.width+x)*4+3] > 128) {
                    particles.push(new Particle(fwCanvas.width/2, fwCanvas.height*0.4, x, y, data.color, true));
                }
            }
        }
        if(callback) callback();
    }

    function explodeShape(x, y, isSub = false) {
        const color = `hsl(${Math.random()*360}, 100%, 70%)`;
        const scale = (window.innerWidth < 600) ? 6 : 10;

        if (isSub) {
            const count = 5;
            for (let i = 0; i < count; i++) {
                const angle = (i / count) * Math.PI * 2;
                const dist = 180 + Math.random() * 60; 
                const tx = x + Math.cos(angle) * dist;
                const ty = y + Math.sin(angle) * dist;
                particles.push(new Particle(x, y, tx, ty, color, false, true));
            }
        } else {
            const shapeType = Math.floor(Math.random() * 5); 
            const count = 70; 

            for (let i = 0; i < count; i++) {
                const t = (i / count) * Math.PI * 2;
                let tx, ty;

                switch(shapeType) {
                    case 0: // LOVE
                        tx = x + scale * (16 * Math.pow(Math.sin(t), 3));
                        ty = y - scale * (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                        break;
                    case 1: // KUPU-KUPU
                        const rK = (Math.exp(Math.sin(t)) - 2 * Math.cos(4*t) + Math.pow(Math.sin((2*t-Math.PI)/24), 5)) * scale * 5;
                        tx = x + Math.cos(t) * rK;
                        ty = y - Math.sin(t) * rK;
                        break;
                    case 2: // BINTANG
                        const rS = scale * 12 * (i % 2 === 0 ? 1 : 0.5);
                        tx = x + Math.cos(t) * rS;
                        ty = y + Math.sin(t) * rS;
                        break;
                    case 3: // EMOT KISS
                        tx = x + scale * 10 * Math.cos(t);
                        ty = y + scale * 5 * Math.pow(Math.sin(t), 3);
                        break;
                    default: // BULAT NORMAL
                        tx = x + Math.cos(t) * scale * 10 * Math.random();
                        ty = y + Math.sin(t) * scale * 10 * Math.random();
                }
                particles.push(new Particle(x, y, tx, ty, color, false));
            }
        }
    }

    class Particle {
        constructor(sx, sy, tx, ty, color, isText, willExplodeAgain = false) {
            this.x = sx; this.y = sy; this.tx = tx; this.ty = ty;
            this.color = color; this.alpha = 1; this.state = 'move';
            this.sustain = isText ? 100 : 30;
            this.decay = isText ? 0.01 : 0.02;
            this.willExplodeAgain = willExplodeAgain;
            this.history = [];
        }
        update() {
            if (this.state === 'move') {
                if(this.willExplodeAgain) {
                    this.history.push({x: this.x, y: this.y});
                    if(this.history.length > 8) this.history.shift();
                }

                this.x += (this.tx - this.x) * 0.1;
                this.y += (this.ty - this.y) * 0.1;
                if (Math.hypot(this.tx-this.x, this.ty-this.y) < 5) {
                    if(this.willExplodeAgain) {
                        this.state = 'done';
                        playSfx('firework-burst', 0.2);
                        explodeShape(this.x, this.y, false);
                    } else {
                        this.state = 'sustain';
                    }
                }
            } else if (this.state === 'sustain') {
                this.sustain--; if (this.sustain <= 0) this.state = 'fall';
            } else if (this.state === 'fall') {
                this.y += 0.8; this.alpha -= this.decay;
            }
        }
        draw() {
            if (this.alpha <= 0 || this.state === 'done') return;
            
            if(this.willExplodeAgain && this.history.length > 1) {
                ctx.beginPath();
                ctx.moveTo(this.history[0].x, this.history[0].y);
                for(let p of this.history) ctx.lineTo(p.x, p.y);
                ctx.strokeStyle = this.color;
                ctx.globalAlpha = this.alpha * 0.4;
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            ctx.globalAlpha = this.alpha; 
            ctx.fillStyle = this.color;
            ctx.beginPath(); 
            ctx.arc(this.x, this.y, 2, 0, Math.PI*2); 
            ctx.fill();
        }
    }

    function animate() {
        ctx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
        
        rockets.forEach((r, i) => { 
            r.update(); r.draw(); 
            if(!r.alive) rockets.splice(i,1); 
        });

        let hasActiveSub = false;
        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update(); 
            particles[i].draw();
            if (particles[i].willExplodeAgain) hasActiveSub = true;
            if (particles[i].alpha <= 0 || particles[i].state === 'done') particles.splice(i, 1);
        }

        if (!hasActiveSub && !rockets.some(r => r.isSub)) {
            isSubExplosionActive = false;
        }

        requestAnimationFrame(animate);
    }

    fwCanvas.addEventListener('mousedown', (e) => {
        if(canInteract) {
            // Acak kembang api biasa atau beranak saat di tap
            const isSub = Math.random() > 0.5;
            if (!isSubExplosionActive || !isSub) {
                rockets.push(new Rocket(fwCanvas.width/2, fwCanvas.height, e.clientX, e.clientY, false, null, null, isSub));
            } else {
                // Jika sedang banyak kembang api beranak, kirim yang biasa saja agar stabil
                rockets.push(new Rocket(fwCanvas.width/2, fwCanvas.height, e.clientX, e.clientY, false, null, null, false));
            }
        }
    });

    function showFinalScreen() {
        sfxMuted = true;
        clearInterval(bgInterval);
        document.getElementById('fireworks-layer').style.display = 'none';
        document.getElementById('final-screen').style.display = 'flex';
    }

    window.addEventListener('resize', resize);
    resize();
</script>
</body>
</html>